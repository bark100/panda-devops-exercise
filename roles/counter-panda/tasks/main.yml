---
- name: Deploy!
  copy: src=counter-panda dest=/tmp/ owner=root group=root mode=0755
  register: new_version # save state when deploying new version

- name: Stop!
  command: /tmp/counter-panda/stop.sh
  args:
    removes: /tmp/counter-panda.pid # stop only if service is up
  when: new_version.changed # stop after new version is deployed
  ignore_errors: yes
  register: stopped # save stopped state

- name: Run!
  command: /tmp/counter-panda/run.sh
  args:
    creates: /tmp/counter-panda.pid
  when: new_version.changed or stopped.changed # run after new version deployment + after stopping

